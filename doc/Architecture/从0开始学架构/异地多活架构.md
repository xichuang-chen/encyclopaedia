# 异地多活架构
为什么要有这么个架构?  
> 不要把鸡蛋放到一个篮子里。 万一那个地方地震了，你所有的什么集群部署，都玩完  

**理解的两个点**  
- 异地: 部署在多个地方
- 多活: 不同地理位置上的系统都能够提供业务服务

**两个标准**  
- 正常情况下，用户无论访问哪一个地点的业务系统，都能够得到正确的业务服务。
- 某个地方业务异常的时候，用户访问其他地方正常的业务系统，能够得到正确的业务服务。

## 应用场景
不是什么系统都要上这玩意的，大部分系统就没必要  
劝退的两个原因    
- 系统复杂度贼高
- 成本贼大

**什么场景下使用**  
> 这类业务系统中断后，对用户的影响很大。比如,支付宝，滴滴等，如果挂了的话，用户无法使用，无法忍受  

**什么场景下谨慎使用**  
> 这类业务系统中断后，对用户的影响不是很大。比如新闻网站，博客网站，公司内部网站啥的。挂一会没事，用户可以看其他的先  
> 但是，不是说一定没必要用哈，对于用户来说，你挂了对他影响不大，他可以看其他网站新闻，但是对于公司来说，
> 是影响他的口碑的，是流失用户的，所以公司看情况使用，比如rea好像有的就用了


## 架构

集群部署或者数据分区做不了异地多活吗  
**前边讲的数据分区 为啥不行**  
> 备份系统平常没有流量，如果直接上线可能触发平常测试不到的故障。
再实时的系统也会有数据延时，如果涉及到金融这种系统，仍然是不敢直接切换的。
系统运行过程中会有很多中间数据，缓存数据等。系统不经过预热直接把流量倒过来，大流量会直接把系统拖垮

**集群部署，把集群的机器放到不同的地区来做可以吗**  
> 大致好像就是这么做的，但是越远响应越慢

### 同城异区
- 应对机房级的故障，如果全城级的故障比如停电地震啥的，无能为力
- 实现简单
- 应对机房级故障的最优解
### 跨城异地
问题很明显，传输带来的数据不一致问题  
支付宝等金融相关的系统，对余额这类数据，一般不会做跨城异地的多活架构，而只能采用同城异区这种架构。  
而对数据一致性要求不那么高，或者数据不怎么改变，或者即使数据丢失影响也不大的业务，跨城异地多活就能够派上用场了。
例如，用户登录（数据不一致时用户重新登录即可）、新闻类网站（一天内的新闻数据变化较少）、微博类网站（丢失用户发布的微博或者评论影响不大），这些业务采用跨城异地多活，能够很好地应对极端灾难的场景。

### 跨国

## 异地多活架构技巧
- 保证核心业务的异地多活；做什么最忌讳对所有功能做
- 保证最终一致性，不保证实时一致性
  > 如何做？ 看 采用多种手段同步数据
- 采用多种手段同步数据
  > 现有的存储系统一般都有，比如mysql的主备复制、Redis 的 Cluster 功能、Elasticsearch 的集群功能  
  自己设计的话
  - 消息队列，比如把账号信息放到一个公共的消息队列中，消息队列推给各个节点，肯定还是会有不一致问题，但是好很多。 抽出公共模块，而不是把信息存到某一个节点造成不一致问题
  - 二次拉取。A节点没有，就去B节点主动取，暂时不知道A什么时机去拉，去哪拉。 就先消息队列吧
- 只保证绝大部分用户的异地多活；核心业务的绝大多数

***所以，一句话，一般是只读业务做异地多活或者是对数据一致性要求不高的***

## 问题
假设我们做了前面提到的高可用存储架构中的数据分区备份，又通过自动化运维能够保证 1 分钟就能将全部系统正常启动，那是否意味着没有必要做异地多活了？
> 还是那句话，备份和多活还不太一样，备份的没被线上测试过，鬼知道你切换城备份之后会出现什么故障，所以不建议
