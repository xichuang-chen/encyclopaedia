# Auth0
## 一些术语
- **OAuth2**: [OAuth2](https://datatracker.ietf.org/doc/html/rfc6749)是一种标准协议，定义了如何授权
- **OIDC(Open ID Connect)**: 定义在identify provider最上层的用于认证的
- **Identify Provider**: 用于认证的，auth0就是一种实现
- **Auth0**: 一种实现了这么一套认证机制的服务

## 如何实现
![image.png](auth0.png)  

- Step1 当客户端首次请求数据时，客户端发现没有refresh token 和 access token, 
  - 会向 auth0 发送 [Authorization Request](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.1)重定向到auth0的登录页面,
  请求格式按照协议规定，其中有个参数叫 `response_type`, 需要设为 `code`,  作用是，response 给我返回code,具体作用看下文  
    ```
    请求示例
    GET /authorize?response_type=code&client_id=s6BhdRkqt3&state=xyz&redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb
    Host: server.example.com
    ```
  - 用户在 Auth0 的登录页面输入凭据（用户名和密码）
  - [官方doc详情](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.1)
- Step1.rsp auth0 校验请求凭据, 然后使用请求中的 `redirect_uri` 加上生成的 `code`，返回给client
    ```
     rsponse 示例   
     HTTP/1.1 302 Found
     Location: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA&state=xyz
    ```
  - The authorization code generated by the authorization server, The authorization code MUST expire shortly after it is issued to mitigate the risk of leaks. 只能被使用一次
  - state 参数要和request 中的 state 参数一致
  - [官方doc详情](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.2)

- Step2 Access Token Request
  ```
  POST /token HTTP/1.1
  Host: server.example.com
  Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
  Content-Type: application/x-www-form-urlencoded
  
  grant_type=authorization_code&code=SplxlOBeZQQYbYS6WxSbIA&redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb
  ```
  - grant_type 必须是 authorization_code, code 必须是 step1.rsp issued
  - redirect_uri 必须是 step1 中请求的  
  - [官方doc详情](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.3)
  Authorization server 校验完 code, redirect_uri 等之后，就发token了

- Step2.rsp
  ```
  An example successful response:

  HTTP/1.1 200 OK
  Content-Type: application/json;charset=UTF-8
  Cache-Control: no-store
  Pragma: no-cache
  
  {
   "access_token":"2YotnFZFEjr1zCsicMWpAA",
   "token_type":"example",
   "expires_in":3600,
   "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",
   "example_parameter":"example_value"
  }
  ```
  - refresh token 是可选的
  - [官方doc详情](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.4)
- Step4 Spring security 相关的包会做和auth0服务打交道，获取验证access token的方法, 只需要引入这些包就好
- Step5  
  ```
  POST /token HTTP/1.1
  Host: server.example.com
  Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
  Content-Type: application/x-www-form-urlencoded
  
  grant_type=refresh_token&refresh_token=tGzv3JOkF0XG5Qx2TlKWIA
  ```
  - grant_type MUST be set to "refresh_token".
  - [官方doc详情](https://datatracker.ietf.org/doc/html/rfc6749#section-6)
